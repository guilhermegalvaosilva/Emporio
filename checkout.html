<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout | BioVida</title>
    <link rel="stylesheet" href="/style.css" />

    <style>
      :root {
        --ink: #0f0f10;
        --muted: rgba(0, 0, 0, 0.62);
        --line: rgba(0, 0, 0, 0.1);
        --soft: #f5f5f5;
        --card: #ffffff;
        --green: #1e7a34;
      }
      * {
        box-sizing: border-box;
        border-radius: 0 !important;
      }
      body {
        margin: 0;
        background: #fff;
        color: var(--ink);
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
      }
      a {
        color: inherit;
      }

      /* ===== Header ===== */
      .nav {
        border-bottom: 1px solid var(--line);
        background: #fff;
      }
      .nav__wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .nav__side {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .nav__link {
        text-decoration: none;
        font-weight: 900;
        font-size: 12px;
        letter-spacing: 0.08em;
      }
      .brand {
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        line-height: 1.05;
      }
      .brand__emp {
        font-weight: 900;
        letter-spacing: 0.18em;
        font-size: 12px;
      }
      .brand__name {
        font-weight: 900;
        letter-spacing: 0.02em;
        font-size: 18px;
      }
      .brand__sub {
        font-weight: 800;
        letter-spacing: 0.14em;
        font-size: 10px;
        color: rgba(0, 0, 0, 0.65);
        margin-top: 4px;
      }

      /* ===== Page ===== */
      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 28px 16px 80px;
      }
      .head {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 14px;
        padding: 18px 0;
        border-bottom: 1px solid var(--line);
        margin-bottom: 18px;
      }
      .head h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 900;
        letter-spacing: -0.02em;
      }
      .head p {
        margin: 6px 0 0;
        color: var(--muted);
        font-weight: 700;
        font-size: 13px;
      }
      .back {
        font-weight: 900;
        text-decoration: none;
        border: 1px solid var(--line);
        padding: 10px 12px;
        font-size: 12px;
        letter-spacing: 0.08em;
      }

      .layout {
        display: grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap: 16px;
        align-items: start;
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        border: 1px solid var(--line);
        background: var(--card);
        padding: 16px;
      }
      .panel__title {
        margin: 0 0 12px;
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      /* ===== Cart items ===== */
      .item {
        display: grid;
        grid-template-columns: 64px 1fr auto;
        gap: 12px;
        align-items: center;
        padding: 14px 0;
        border-top: 1px solid var(--line);
      }
      .item:first-child {
        border-top: 0;
        padding-top: 0;
      }
      .item__img {
        width: 64px;
        height: 64px;
        object-fit: contain;
        background: var(--soft);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .item__name {
        margin: 0 0 4px;
        font-weight: 900;
        font-size: 13px;
      }
      .item__meta {
        margin: 0;
        color: var(--muted);
        font-weight: 700;
        font-size: 12px;
      }
      .item__right {
        text-align: right;
      }
      .item__price {
        font-weight: 900;
        color: var(--green);
      }

      .qty {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
        margin-top: 10px;
      }
      .qty button {
        width: 34px;
        height: 34px;
        border: 1px solid var(--line);
        background: #fff;
        font-weight: 900;
        cursor: pointer;
      }
      .qty span {
        min-width: 22px;
        text-align: center;
        font-weight: 900;
      }

      .remove {
        margin-top: 10px;
        border: 1px solid var(--line);
        background: #fff;
        padding: 10px 12px;
        font-weight: 900;
        cursor: pointer;
        width: fit-content;
      }

      /* ===== Totals ===== */
      .totals {
        border-top: 1px solid var(--line);
        margin-top: 14px;
        padding-top: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-weight: 900;
      }
      .row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }
      .row small {
        color: var(--muted);
        font-weight: 800;
      }
      .neg {
        color: #b00020;
      }

      /* ===== Form ===== */
      .form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .full {
        grid-column: 1 / -1;
      }

      .field label {
        display: block;
        font-size: 11px;
        font-weight: 900;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(0, 0, 0, 0.75);
        margin-bottom: 6px;
      }
      .field input,
      .field select,
      .field textarea {
        width: 100%;
        border: 1px solid var(--line);
        padding: 12px;
        font-size: 14px;
        outline: 0;
        background: #fff;
        font-weight: 700;
      }
      .field textarea {
        min-height: 92px;
        resize: vertical;
      }

      .btn {
        border: 1px solid var(--line);
        background: #fff;
        color: var(--ink);
        padding: 12px 14px;
        font-weight: 900;
        cursor: pointer;
        letter-spacing: 0.04em;
      }
      .btn--primary {
        background: var(--ink);
        border-color: var(--ink);
        color: #fff;
      }
      .btn:hover {
        opacity: 0.92;
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .actions .btn {
        flex: 1;
      }

      .empty {
        border: 1px dashed var(--line);
        padding: 14px;
        text-align: center;
        color: var(--muted);
        font-weight: 800;
      }

      /* ===== PIX (QR) ===== */
      .pixBox {
        border: 1px solid var(--line);
        padding: 12px;
        margin-top: 10px;
        background: #fff;
      }
      .pixTitle {
        font-weight: 900;
        margin: 0 0 10px;
        font-size: 12px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }
      .pixRow {
        display: grid;
        grid-template-columns: 1fr 240px;
        gap: 12px;
        align-items: start;
      }
      @media (max-width: 560px) {
        .pixRow {
          grid-template-columns: 1fr;
        }
      }
      .pixQr {
        width: 240px;
        height: 240px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: #fff;
        object-fit: contain;
      }
      .pixMeta {
        color: rgba(0, 0, 0, 0.62);
        line-height: 1.7;
        font-weight: 800;
        font-size: 12px;
      }
      .pixKeyLine {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 10px;
      }

      /* ===== Footer ===== */
      .footer {
        background: #0b0c0f;
        color: rgba(255, 255, 255, 0.92);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .footer__wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 22px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .footer small {
        color: rgba(255, 255, 255, 0.62);
        font-weight: 700;
      }
      .footer a {
        color: rgba(255, 255, 255, 0.92);
        text-decoration: none;
        font-weight: 900;
        border-bottom: 1px solid rgba(255, 255, 255, 0.18);
      }

      /* helper */
      .hint {
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
        margin-top: 6px;
      }
    </style>
  </head>

  <body>
    <header class="nav">
      <div class="nav__wrap">
        <nav class="nav__side nav__side--left">
          <a href="/index.html" class="nav__link">HOME</a>
          <a href="/mais-vendidos.html" class="nav__link">PRODUTOS</a>
        </nav>

        <a href="/index.html" class="brand" aria-label="Empório BioVida">
          <span class="brand__emp">EMPÓRIO</span>
          <span class="brand__name"
            ><span class="brand__bio">Bio</span
            ><span class="brand__vida">Vida</span></span
          >
          <span class="brand__sub">PRODUTOS NATURAIS</span>
        </a>

        <nav class="nav__side nav__side--right">
          <a href="/sobre.html" class="nav__link">SOBRE</a>
          <a href="#footer" class="nav__link">CONTATO</a>
        </nav>
      </div>
    </header>

    <main class="page">
      <div class="head">
        <div>
          <h1>Checkout</h1>
          <p>Revise seu carrinho, preencha seus dados e pague via Pix.</p>
        </div>
        <a class="back" href="/mais-vendidos.html">VOLTAR AOS PRODUTOS</a>
      </div>

      <div class="layout">
        <!-- ===== Carrinho ===== -->
        <section class="panel" aria-label="Resumo do carrinho">
          <h2 class="panel__title">Seu carrinho</h2>
          <div id="cartList"></div>

          <div class="totals">
            <div class="row">
              <small>Subtotal</small><span id="subtotal">R$ 0,00</span>
            </div>
            <div class="row">
              <small>Frete</small><span id="shipping">R$ 0,00</span>
            </div>
            <div class="row">
              <small>Desconto</small
              ><span id="discount" class="neg">- R$ 0,00</span>
            </div>
            <div class="row">
              <small>Total</small
              ><span id="total" style="color: var(--green)">R$ 0,00</span>
            </div>
          </div>
        </section>

        <!-- ===== Dados ===== -->
        <aside class="panel" aria-label="Dados do pedido">
          <h2 class="panel__title">Dados do cliente</h2>

          <form id="checkoutForm" class="form">
            <!-- Identificação -->
            <div class="field full">
              <label for="name">Nome completo</label>
              <input
                id="name"
                name="name"
                type="text"
                placeholder="Seu nome"
                required
              />
            </div>

            <div class="field">
              <label for="cpf">CPF</label>
              <input
                id="cpf"
                name="cpf"
                type="text"
                placeholder="000.000.000-00"
                inputmode="numeric"
                required
              />
            </div>

            <div class="field">
              <label for="birth">Data de nascimento</label>
              <input id="birth" name="birth" type="date" />
            </div>

            <div class="field full">
              <label for="email">E-mail</label>
              <input
                id="email"
                name="email"
                type="email"
                placeholder="seuemail@exemplo.com"
                required
              />
            </div>

            <div class="field full">
              <label for="phone">WhatsApp</label>
              <input
                id="phone"
                name="phone"
                type="tel"
                placeholder="(61) 9xxxx-xxxx"
                required
              />
            </div>

            <!-- Recebimento -->
            <div class="field">
              <label for="method">Recebimento</label>
              <select id="method" name="method" required>
                <option value="Entrega">Entrega</option>
                <option value="Retirada">Retirada</option>
              </select>
            </div>

            <div class="field">
              <label for="shippingZone">Região</label>
              <select id="shippingZone" name="shippingZone">
                <option value="Plano Piloto">Plano Piloto (Free)</option>
                <option value="Asa Sul / Asa Norte">
                  Asa Sul / Asa Norte (Free)
                </option>
                <option value="Águas Claras">Águas Claras (Free)</option>
                <option value="Taguatinga">Taguatinga (Free)</option>
                <option value="Outras regiões">
                  Outras regiões (R$ 20,00)
                </option>
              </select>
            </div>

            <!-- Endereço -->
            <div class="field">
              <label for="cep">CEP</label>
              <input
                id="cep"
                name="cep"
                type="text"
                placeholder="00000-000"
                inputmode="numeric"
              />
            </div>

            <div class="field">
              <label for="uf">UF</label>
              <select id="uf" name="uf">
                <option value="DF" selected>DF</option>
                <option value="GO">GO</option>
                <option value="SP">SP</option>
                <option value="RJ">RJ</option>
                <option value="MG">MG</option>
                <option value="BA">BA</option>
                <option value="PR">PR</option>
                <option value="SC">SC</option>
                <option value="RS">RS</option>
                <option value="ES">ES</option>
                <option value="PE">PE</option>
                <option value="CE">CE</option>
                <option value="PA">PA</option>
                <option value="AM">AM</option>
                <option value="MA">MA</option>
                <option value="PB">PB</option>
                <option value="RN">RN</option>
                <option value="PI">PI</option>
                <option value="AL">AL</option>
                <option value="SE">SE</option>
                <option value="MT">MT</option>
                <option value="MS">MS</option>
                <option value="TO">TO</option>
                <option value="RO">RO</option>
                <option value="RR">RR</option>
                <option value="AP">AP</option>
                <option value="AC">AC</option>
              </select>
            </div>

            <div class="field full">
              <label for="street">Rua / Avenida</label>
              <input
                id="street"
                name="street"
                type="text"
                placeholder="Ex.: Rua X, Av. Y"
              />
            </div>

            <div class="field">
              <label for="number">Número</label>
              <input
                id="number"
                name="number"
                type="text"
                placeholder="Ex.: 123"
              />
            </div>

            <div class="field">
              <label for="complement">Complemento</label>
              <input
                id="complement"
                name="complement"
                type="text"
                placeholder="Apto, bloco, lote..."
              />
            </div>

            <div class="field full">
              <label for="district">Bairro</label>
              <input
                id="district"
                name="district"
                type="text"
                placeholder="Ex.: Asa Sul"
              />
            </div>

            <div class="field full">
              <label for="city">Cidade</label>
              <input
                id="city"
                name="city"
                type="text"
                placeholder="Ex.: Brasília"
                value="Brasília"
              />
            </div>

            <!-- PIX -->
            <div class="field full">
              <label>Pagamento</label>
              <div class="pixBox">
                <p class="pixTitle">Pix (QR Code)</p>
                <div class="pixRow">
                  <div>
                    <div class="pixKeyLine">
                      <span class="pixMeta">Chave Pix:</span>
                      <span id="pixKeyText" style="font-weight: 900"
                        >46792469874</span
                      >
                      <button
                        class="btn"
                        type="button"
                        id="copyPixKeyBtn"
                        style="padding: 10px 12px"
                      >
                        Copiar chave
                      </button>
                    </div>
                    <div class="pixMeta">
                      Valor do pedido:
                      <span id="pixAmountText" style="font-weight: 900"
                        >R$ 0,00</span
                      >
                      <br />
                      Escaneie o QR Code para pagar.
                      <div class="hint">
                        Depois clique em “Finalizar no WhatsApp” e envie o
                        comprovante.
                      </div>
                    </div>
                  </div>
                  <div>
                    <img
                      id="pixQrImg"
                      class="pixQr"
                      alt="QR Code do Pix"
                      src="/img/pix-static.png"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Cupom -->
            <div class="field full">
              <label for="coupon">Cupom</label>
              <div class="couponBox">
                <div class="couponTop">
                  <div class="couponHint">Digite e clique em aplicar</div>
                  <div
                    id="couponMsg"
                    class="badge badge--info"
                    style="display: none"
                  ></div>
                </div>
                <div class="couponRow">
                  <input
                    id="coupon"
                    type="text"
                    placeholder="Ex.: BIO10 ou FRETEGRATIS"
                    autocomplete="off"
                    inputmode="text"
                  />
                  <button class="btn couponBtn" id="applyCoupon" type="button">
                    Aplicar
                  </button>
                </div>
              </div>
            </div>

            <div class="field full">
              <label for="notes">Observações</label>
              <textarea
                id="notes"
                name="notes"
                placeholder="Ex.: horário, ponto de referência, sem substituições..."
              ></textarea>
            </div>

            <div class="actions full">
              <button class="btn btn--primary" type="submit">
                Finalizar no WhatsApp
              </button>
              <button class="btn" type="button" id="clearCart">
                Limpar carrinho
              </button>
            </div>
          </form>
        </aside>
      </div>
    </main>

    <footer class="footer" id="footer" aria-label="Rodapé">
      <div class="footer__wrap">
        <small
          >© <span id="footerYear"></span> Empório BioVida. Todos os direitos
          reservados.</small
        >
        <small
          >Atendimento:
          <a
            href="https://wa.me/5561995289436"
            target="_blank"
            rel="noopener noreferrer"
            >WhatsApp</a
          ></small
        >
      </div>
    </footer>

    <script>
      // =========================
      // CONFIG
      // =========================
      const storageKey = "biovida_cart_v1";
      const STORE_WHATSAPP = "5561995289436";
      const PIX_KEY = "46792469874";
      const PIX_MERCHANT_NAME = "EMPORIO BIOVIDA";
      const PIX_MERCHANT_CITY = "BRASILIA";

      const SHIPPING_TABLE = {
        "Plano Piloto": 0,
        "Asa Sul / Asa Norte": 0,
        "Águas Claras": 0,
        Taguatinga: 0,
        "Outras regiões": 20,
      };

      const COUPONS = {
        BIO10: { type: "percent", value: 10 },
        FRETEGRATIS: { type: "shipping", value: 100 },
      };

      const fmt = (n) =>
        n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

      // =========================
      // MASKS / HELPERS
      // =========================
      function onlyDigits(v) {
        return (v || "").replace(/\D/g, "");
      }

      function maskBRPhone(v) {
        const d = onlyDigits(v).slice(0, 11);
        const ddd = d.slice(0, 2);
        const nine = d.slice(2, 3);
        const p1 = d.slice(3, 7);
        const p2 = d.slice(7, 11);
        if (d.length <= 2) return ddd ? `(${ddd}` : "";
        if (d.length <= 3) return `(${ddd}) ${nine}`;
        if (d.length <= 7) return `(${ddd}) ${nine}${p1 ? ` ${p1}` : ""}`;
        return `(${ddd}) ${nine} ${p1}-${p2}`;
      }

      function maskCEP(v) {
        const d = onlyDigits(v).slice(0, 8);
        if (d.length <= 5) return d;
        return `${d.slice(0, 5)}-${d.slice(5)}`;
      }

      function maskCPF(v) {
        const d = onlyDigits(v).slice(0, 11);
        if (d.length <= 3) return d;
        if (d.length <= 6) return `${d.slice(0, 3)}.${d.slice(3)}`;
        if (d.length <= 9)
          return `${d.slice(0, 3)}.${d.slice(3, 6)}.${d.slice(6)}`;
        return `${d.slice(0, 3)}.${d.slice(3, 6)}.${d.slice(6, 9)}-${d.slice(9)}`;
      }

      function openWhatsApp(text) {
        const url = `https://wa.me/${STORE_WHATSAPP}?text=${encodeURIComponent(text)}`;
        window.open(url, "_blank", "noopener,noreferrer");
      }

      function lineItemsText(items) {
        return items
          .map((it) => `• ${it.qty}x ${it.name} — ${fmt(it.price * it.qty)}`)
          .join("\n");
      }

      // =========================
      // CART STORAGE
      // =========================
      const loadCart = () => {
        try {
          return JSON.parse(localStorage.getItem(storageKey)) || {};
        } catch {
          return {};
        }
      };
      const saveCart = (cart) =>
        localStorage.setItem(storageKey, JSON.stringify(cart));
      let cart = loadCart();

      // =========================
      // DOM
      // =========================
      const cartList = document.getElementById("cartList");
      const subtotalEl = document.getElementById("subtotal");
      const shippingEl = document.getElementById("shipping");
      const discountEl = document.getElementById("discount");
      const totalEl = document.getElementById("total");

      const form = document.getElementById("checkoutForm");
      const methodEl = document.getElementById("method");
      const zoneEl = document.getElementById("shippingZone");

      const couponInput = document.getElementById("coupon");
      const applyCouponBtn = document.getElementById("applyCoupon");
      const couponMsg = document.getElementById("couponMsg");

      const clearCartBtn = document.getElementById("clearCart");

      const phoneEl = document.getElementById("phone");
      const cpfEl = document.getElementById("cpf");
      const cepEl = document.getElementById("cep");

      const pixKeyText = document.getElementById("pixKeyText");
      const copyPixKeyBtn = document.getElementById("copyPixKeyBtn");
      const pixAmountText = document.getElementById("pixAmountText");
      const pixQrImg = document.getElementById("pixQrImg");

      // footer year
      const footerYear = document.getElementById("footerYear");
      if (footerYear) footerYear.textContent = new Date().getFullYear();

      if (pixKeyText) pixKeyText.textContent = PIX_KEY;

      // masks
      phoneEl.addEventListener(
        "input",
        (e) => (e.target.value = maskBRPhone(e.target.value)),
      );
      cpfEl.addEventListener(
        "input",
        (e) => (e.target.value = maskCPF(e.target.value)),
      );
      cepEl.addEventListener(
        "input",
        (e) => (e.target.value = maskCEP(e.target.value)),
      );

      copyPixKeyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(PIX_KEY);
          alert("Chave Pix copiada!");
        } catch {
          alert("Não foi possível copiar automaticamente. Copie manualmente.");
        }
      });

      // =========================
      // COUPON
      // =========================
      let appliedCoupon = "";
      let couponApplied = false;

      function setCouponUI(type, text) {
        if (!text) {
          couponMsg.style.display = "none";
          couponMsg.textContent = "";
          couponMsg.className = "badge badge--info";
        } else {
          couponMsg.style.display = "inline-flex";
          couponMsg.textContent = text;
          couponMsg.className =
            type === "ok"
              ? "badge badge--ok"
              : type === "err"
                ? "badge badge--err"
                : "badge badge--info";
        }

        if (couponApplied && appliedCoupon) {
          couponInput.value = appliedCoupon;
          couponInput.disabled = true;
          applyCouponBtn.textContent = "Remover";
        } else {
          couponInput.disabled = false;
          applyCouponBtn.textContent = "Aplicar";
        }
      }

      function tryApplyCoupon() {
        const code = (couponInput.value || "").toUpperCase().trim();
        if (!code) {
          couponApplied = false;
          appliedCoupon = "";
          setCouponUI("info", "Digite um cupom para aplicar.");
          render();
          return;
        }
        if (!COUPONS[code]) {
          couponApplied = false;
          appliedCoupon = "";
          setCouponUI("err", "Cupom inválido.");
          render();
          return;
        }
        couponApplied = true;
        appliedCoupon = code;
        setCouponUI("ok", `Aplicado: ${code}`);
        render();
      }

      function removeCoupon() {
        couponApplied = false;
        appliedCoupon = "";
        couponInput.value = "";
        setCouponUI("", "");
        render();
      }

      applyCouponBtn.addEventListener("click", () =>
        couponApplied ? removeCoupon() : tryApplyCoupon(),
      );
      couponInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          couponApplied ? removeCoupon() : tryApplyCoupon();
        }
      });
      setCouponUI("", "");

      // =========================
      // TOTALS
      // =========================
      function subtotal() {
        return Object.values(cart).reduce(
          (acc, it) => acc + it.qty * it.price,
          0,
        );
      }
      function shippingCost() {
        if (methodEl.value === "Retirada") return 0;
        return SHIPPING_TABLE[zoneEl.value] ?? 0;
      }
      function discountValue(sub, ship) {
        if (!couponApplied || !appliedCoupon) return 0;
        const c = COUPONS[appliedCoupon];
        if (!c) return 0;
        if (c.type === "percent") return (sub * c.value) / 100;
        if (c.type === "shipping") return ship;
        return 0;
      }

      // =========================
      // PIX EMV -> QR com valor
      // =========================
      function pad2(n) {
        return String(n).padStart(2, "0");
      }
      function sanitizePixText(s, maxLen) {
        const out = String(s || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^A-Za-z0-9 \-\.]/g, "")
          .trim();
        return out.slice(0, maxLen);
      }
      function emvField(id, value) {
        const v = String(value);
        return id + pad2(v.length) + v;
      }
      function crc16ccitt(str) {
        let crc = 0xffff;
        for (let i = 0; i < str.length; i++) {
          crc ^= str.charCodeAt(i) << 8;
          for (let j = 0; j < 8; j++) {
            crc = crc & 0x8000 ? (crc << 1) ^ 0x1021 : crc << 1;
            crc &= 0xffff;
          }
        }
        return crc.toString(16).toUpperCase().padStart(4, "0");
      }

      function buildPixEMV({ key, merchantName, merchantCity, amount, txid }) {
        const name = sanitizePixText(merchantName, 25) || "RECEBEDOR";
        const city = sanitizePixText(merchantCity, 15) || "CIDADE";
        const amt = Number(amount || 0).toFixed(2);

        const mai = emvField(
          "26",
          emvField("00", "BR.GOV.BCB.PIX") + emvField("01", key),
        );
        const mcc = emvField("52", "0000");
        const currency = emvField("53", "986");
        const amountField = Number(amount) > 0 ? emvField("54", amt) : "";
        const country = emvField("58", "BR");
        const mName = emvField("59", name);
        const mCity = emvField("60", city);
        const addData = emvField(
          "62",
          emvField("05", sanitizePixText(txid || "BV", 25) || "BV"),
        );

        const payloadNoCrc =
          emvField("00", "01") +
          emvField("01", "12") +
          mai +
          mcc +
          currency +
          amountField +
          country +
          mName +
          mCity +
          addData +
          "6304";

        return payloadNoCrc + crc16ccitt(payloadNoCrc);
      }

      function updatePixQR(totalValue, txid) {
        if (pixAmountText) pixAmountText.textContent = fmt(totalValue);

        const emv = buildPixEMV({
          key: PIX_KEY,
          merchantName: PIX_MERCHANT_NAME,
          merchantCity: PIX_MERCHANT_CITY,
          amount: totalValue,
          txid: txid || "BV",
        });

        const url =
          "https://chart.googleapis.com/chart?cht=qr&chs=240x240&chl=" +
          encodeURIComponent(emv);

        if (pixQrImg) pixQrImg.src = url;
      }

      // =========================
      // RENDER
      // =========================
      function render() {
        const items = Object.values(cart);

        if (items.length === 0) {
          cartList.innerHTML = `<div class="empty">Seu carrinho está vazio. Volte aos produtos para adicionar itens.</div>`;
          subtotalEl.textContent = fmt(0);
          shippingEl.textContent = fmt(0);
          discountEl.textContent = `- ${fmt(0)}`;
          totalEl.textContent = fmt(0);
          updatePixQR(0, "BV");
          return;
        }

        cartList.innerHTML = items
          .map(
            (it) => `
          <div class="item">
            <img class="item__img" src="${it.img}" alt="${it.name}" />
            <div>
              <p class="item__name">${it.name}</p>
              <p class="item__meta">${it.id} • ${fmt(it.price)} cada</p>
              <div class="qty">
                <button type="button" data-dec="${it.id}">−</button>
                <span>${it.qty}</span>
                <button type="button" data-inc="${it.id}">+</button>
              </div>
              <button class="remove" type="button" data-rem="${it.id}">Remover</button>
            </div>
            <div class="item__right">
              <div class="item__price">${fmt(it.price * it.qty)}</div>
            </div>
          </div>
        `,
          )
          .join("");

        const sub = subtotal();
        const ship = shippingCost();
        const disc = discountValue(sub, ship);
        const tot = Math.max(0, sub + ship - disc);

        subtotalEl.textContent = fmt(sub);
        shippingEl.textContent = fmt(ship);
        discountEl.textContent = `- ${fmt(disc)}`;
        totalEl.textContent = fmt(tot);

        updatePixQR(tot, "BV");
      }

      function inc(id) {
        if (!cart[id]) return;
        cart[id].qty += 1;
        saveCart(cart);
        render();
      }
      function dec(id) {
        if (!cart[id]) return;
        cart[id].qty -= 1;
        if (cart[id].qty <= 0) delete cart[id];
        saveCart(cart);
        render();
      }
      function rem(id) {
        if (!cart[id]) return;
        delete cart[id];
        saveCart(cart);
        render();
      }

      cartList.addEventListener("click", (e) => {
        const a = e.target.closest("[data-inc]");
        const b = e.target.closest("[data-dec]");
        const c = e.target.closest("[data-rem]");
        if (a) inc(a.dataset.inc);
        if (b) dec(b.dataset.dec);
        if (c) rem(c.dataset.rem);
      });

      methodEl.addEventListener("change", () => {
        const isDelivery = methodEl.value === "Entrega";
        // habilita/obriga endereço só se entrega
        const required = isDelivery;

        ["cep", "street", "number", "district", "city"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.disabled = !isDelivery;
          el.required = required;
          if (!isDelivery) el.value = "";
        });

        document.getElementById("complement").disabled = !isDelivery;
        document.getElementById("uf").disabled = !isDelivery;

        zoneEl.disabled = !isDelivery;
        render();
      });

      zoneEl.addEventListener("change", render);

      clearCartBtn.addEventListener("click", () => {
        cart = {};
        saveCart(cart);
        render();
      });

      // =========================
      // SUBMIT -> WhatsApp
      // =========================
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const items = Object.values(cart);
        if (items.length === 0) {
          alert("Seu carrinho está vazio.");
          return;
        }

        const get = (id) => (document.getElementById(id)?.value || "").trim();

        const name = get("name");
        const cpf = get("cpf");
        const birth = get("birth");
        const email = get("email");
        const phone = get("phone");

        const method = methodEl.value;
        const zone = zoneEl.value;

        const cep = get("cep");
        const uf = get("uf");
        const street = get("street");
        const number = get("number");
        const complement = get("complement");
        const district = get("district");
        const city = get("city");

        const notes = get("notes");

        const sub = subtotal();
        const ship = shippingCost();
        const disc = discountValue(sub, ship);
        const tot = Math.max(0, sub + ship - disc);

        const couponText =
          couponApplied && appliedCoupon ? `Cupom: ${appliedCoupon}\n` : "";

        const addressText =
          method === "Entrega"
            ? `Endereço:
• CEP: ${cep}
• Rua: ${street}, Nº ${number}${complement ? `, ${complement}` : ""}
• Bairro: ${district}
• Cidade/UF: ${city} - ${uf}
• Região: ${zone}`
            : "Retirada na loja";

        const msg = `Olá! Quero finalizar meu pedido na BioVida.

Cliente:
• Nome: ${name}
• CPF: ${cpf}
• Nascimento: ${birth || "-"}
• Email: ${email}
• WhatsApp: ${phone}

Pedido:
${lineItemsText(items)}

Resumo:
• Subtotal: ${fmt(sub)}
• Frete: ${fmt(ship)}
• Desconto: - ${fmt(disc)}
• Total: ${fmt(tot)}
${couponText}
Recebimento: ${method}

${addressText}

Observações:
${notes || "-"}

Pix:
• Chave: ${PIX_KEY}

Vou enviar o comprovante após o pagamento.`;

        openWhatsApp(msg);
      });

      // init
      // no início assume Entrega habilitado
      zoneEl.disabled = false;
      [
        "cep",
        "street",
        "number",
        "district",
        "city",
        "complement",
        "uf",
      ].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.disabled = false;
      });

      render();
    </script>
  </body>
</html>
